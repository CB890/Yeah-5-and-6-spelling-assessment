<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teacher Dashboard - Spelling Assessment</title>
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .connection-status {
            padding: 20px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #eee;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid #4CAF50;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #666;
        }

        .section {
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        .quiz-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quiz-table th,
        .quiz-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .quiz-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .quiz-table tr:hover {
            background: #f8f9fa;
        }

        .score {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
        }

        .score.excellent { background: #4CAF50; }
        .score.good { background: #2196F3; }
        .score.fair { background: #FF9800; }
        .score.needs-work { background: #f44336; }

        .word-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .word-stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }

        .word-stat.difficult {
            border-left-color: #f44336;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            text-align: center;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #2196F3;
        }

        .btn.secondary:hover {
            background: #1976D2;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }

        .school-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .school-info h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        /* Authentication Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-container h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 2px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .auth-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2em;
            width: 100%;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .auth-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .auth-success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <h2>üîê Teacher Access</h2>
            <p>Enter the teacher access code to view the dashboard</p>
            
            <div id="authError" class="auth-error">
                ‚ùå Incorrect access code. Please try again.
            </div>
            
            <div id="authSuccess" class="auth-success">
                ‚úÖ Access granted! Loading dashboard...
            </div>
            
            <input 
                type="password" 
                id="accessCode" 
                class="auth-input" 
                placeholder="Enter Access Code"
                maxlength="10"
                autocomplete="off"
            >
            
            <button class="auth-btn" onclick="checkAccessCode()">
                üöÄ Access Dashboard
            </button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="font-size: 0.9em; color: #999;">
                    üîí Access codes are provided by your school administrator<br>
                    üìß Contact your IT department if you need assistance
                </p>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="header">
            <h1>üéØ Teacher Dashboard</h1>
            <p>Monitor student progress and spelling performance</p>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            üîå Connecting to database...
        </div>

        <div id="schoolInfo" class="school-info" style="display: none;">
            <h3 id="schoolName">Loading school...</h3>
            <p id="schoolCode">School Code: ---</p>
            <p style="font-size: 0.9em; color: #1976d2; margin-top: 10px;">
                üìä <strong>Showing data for this school only</strong> - Other schools' data is kept separate
            </p>
        </div>

        <div id="loadingSpinner" class="loading">
            <div class="spinner"></div>
            <p>Loading quiz data from database...</p>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalQuizzes">0</div>
                    <div class="stat-label">Total Quizzes</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="averageScore">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="averageTime">0m</div>
                    <div class="stat-label">Average Time</div>
                </div>
            </div>

            <div class="section">
                <h2>üìä Recent Quiz Results</h2>
                <div id="recentQuizzes">
                    <div class="no-data">No quiz results found yet. Students need to complete some quizzes first!</div>
                </div>
            </div>

            <div class="section">
                <h2>üî§ Word Difficulty Analysis</h2>
                <div id="wordStats">
                    <div class="no-data">No word statistics available yet.</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
                <button class="btn secondary" onclick="exportData()">üìÅ Export Results</button>
                <button class="btn secondary" onclick="window.open('index.html', '_blank')">üéØ Launch Quiz</button>
                <button class="btn" onclick="logout()" style="background: #f44336;">üö™ Logout</button>
            </div>
        </div>
    </div>

    <!-- Load the database configuration -->
    <script src="supabase-config.js"></script>
    <script src="teacher-config.js"></script>

    <script>
        // üîê Authentication System
        function getTeacherCodes() {
            return window.TEACHER_CONFIG ? window.TEACHER_CONFIG.accessCodes : {
                'KENT2024': { schoolName: 'Kent College', schoolCode: 'KENT001' },
                'VICT2024': { schoolName: 'Victory Heights Primary School', schoolCode: 'VICT001' },
                'ADMIN2024': { schoolName: 'Administrator', schoolCode: 'ADMIN', isAdmin: true }
            };
        }

        function checkAccessCode() {
            const inputCode = document.getElementById('accessCode').value.toUpperCase();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            const teacherCodes = getTeacherCodes();
            
            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (teacherCodes[inputCode]) {
                // Success - store authentication
                sessionStorage.setItem('teacherAuthenticated', 'true');
                sessionStorage.setItem('teacherSchool', teacherCodes[inputCode].schoolName);
                sessionStorage.setItem('teacherSchoolCode', teacherCodes[inputCode].schoolCode);
                sessionStorage.setItem('authTime', Date.now().toString());
                
                // Show success message
                successDiv.innerHTML = `‚úÖ Access granted for ${teacherCodes[inputCode].schoolName}! Loading dashboard...`;
                successDiv.style.display = 'block';
                
                // Hide auth overlay after short delay
                setTimeout(() => {
                    document.getElementById('authOverlay').style.display = 'none';
                    initializeDashboard();
                }, 1500);
                
            } else {
                // Show error
                errorDiv.style.display = 'block';
                document.getElementById('accessCode').value = '';
                document.getElementById('accessCode').focus();
            }
        }

        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('teacherAuthenticated');
            const authTime = sessionStorage.getItem('authTime');
            const currentTime = Date.now();
            
            // Get session duration from config
            const sessionDuration = window.TEACHER_CONFIG ? 
                window.TEACHER_CONFIG.sessionDuration : 
                4 * 60 * 60 * 1000; // Default 4 hours
            
            // Check if authenticated and session is still valid
            if (isAuthenticated === 'true' && authTime) {
                const sessionAge = currentTime - parseInt(authTime);
                
                if (sessionAge < sessionDuration) {
                    // Valid session - hide auth overlay and start dashboard
                    document.getElementById('authOverlay').style.display = 'none';
                    initializeDashboard();
                    return true;
                }
            }
            
            // Invalid or expired session - show auth overlay
            document.getElementById('authOverlay').style.display = 'flex';
            return false;
        }

        function logout() {
            sessionStorage.removeItem('teacherAuthenticated');
            sessionStorage.removeItem('teacherSchool');
            sessionStorage.removeItem('authTime');
            location.reload();
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('accessCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkAccessCode();
                }
            });
        });

        function initializeDashboard() {
            // Initialize the dashboard after authentication
            setTimeout(async () => {
                window.teacherDashboard = new TeacherDashboard();
                await window.teacherDashboard.init();
            }, 1000);
        }

        // üéØ Dashboard controller
        class TeacherDashboard {
            constructor() {
                this.quizData = [];
                this.wordStats = [];
                this.isConnected = false;
            }

            async init() {
                console.log('üöÄ Initializing Teacher Dashboard...');
                
                try {
                    // Wait for database service to be ready
                    await this.waitForDatabaseService();
                    
                    // Update connection status
                    this.updateConnectionStatus(true);
                    
                    // Load school information and wait for it to complete
                    await this.showSchoolInfo();
                    
                    // Load all the quiz data (now that school context is set)
                    await this.loadDashboardData();
                    
                    console.log('‚úÖ Dashboard ready!');
                    
                } catch (error) {
                    console.error('‚ùå Dashboard initialization failed:', error);
                    this.updateConnectionStatus(false);
                    this.hideLoading();
                }
            }

            async waitForDatabaseService() {
                let attempts = 0;
                const maxAttempts = 10;
                
                while (attempts < maxAttempts) {
                    if (window.databaseService && window.databaseService.isConnected) {
                        console.log('‚úÖ Database service is ready!');
                        this.isConnected = true;
                        return;
                    }
                    
                    console.log(`‚è≥ Waiting for database service... (${attempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }
                
                throw new Error('Database service not available');
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    statusEl.innerHTML = '‚úÖ Connected to database successfully!';
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.innerHTML = '‚ùå Database connection failed - showing offline mode';
                }
            }

            async showSchoolInfo() {
                const schoolInfo = document.getElementById('schoolInfo');
                const schoolName = document.getElementById('schoolName');
                const schoolCode = document.getElementById('schoolCode');
                
                // Get the authenticated teacher's school
                const teacherSchool = sessionStorage.getItem('teacherSchool');
                const teacherSchoolCode = sessionStorage.getItem('teacherSchoolCode');
                
                if (teacherSchool && teacherSchoolCode) {
                    schoolName.textContent = `üè´ ${teacherSchool}`;
                    schoolCode.textContent = `School Code: ${teacherSchoolCode}`;
                    schoolInfo.style.display = 'block';
                    
                    // Check if this is an admin user
                    if (teacherSchoolCode === 'ADMIN') {
                        this.isAdmin = true;
                        schoolInfo.querySelector('p:last-child').innerHTML = 
                            'üëë <strong>Administrator View</strong> - Showing data from all schools';
                    }
                    
                    // Set the school context for database queries and WAIT for it
                    await this.setSchoolContext(teacherSchoolCode);
                } else if (window.databaseService && window.databaseService.currentSchool) {
                    const school = window.databaseService.currentSchool;
                    schoolName.textContent = `üè´ ${school.school_name}`;
                    schoolCode.textContent = `School Code: ${school.school_code}`;
                    schoolInfo.style.display = 'block';
                }
            }

            async setSchoolContext(schoolCode) {
                try {
                    console.log('üîç Looking up school with code:', schoolCode);
                    
                    // Look up the school in the database to get the school ID
                    const { data: schoolData, error } = await window.databaseService.supabase
                        .from('schools')
                        .select('*')
                        .eq('school_code', schoolCode)
                        .single();

                    if (error) {
                        console.error('‚ùå Could not find school:', error);
                        console.error('Error details:', error);
                        
                        // Fallback: try to get all schools to see what's available
                        const { data: allSchools } = await window.databaseService.supabase
                            .from('schools')
                            .select('*');
                        console.log('üìã Available schools in database:', allSchools);
                        return;
                    }

                    // Set the current school context for filtering
                    this.currentSchoolId = schoolData.id;
                    this.currentSchoolData = schoolData;
                    
                    console.log('‚úÖ Successfully set school context:');
                    console.log('   School Name:', schoolData.school_name);
                    console.log('   School ID:', schoolData.id);
                    console.log('   School Code:', schoolData.school_code);
                    
                } catch (error) {
                    console.error('‚ùå Error setting school context:', error);
                }
            }

            async loadDashboardData() {
                try {
                    console.log('üìä Loading quiz data...');
                    
                    let quizQuery = window.databaseService.supabase
                        .from('quiz_sessions')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    // Filter by school unless user is admin
                    if (!this.isAdmin) {
                        const schoolId = this.currentSchoolId || window.databaseService.currentSchool?.id;
                        
                        console.log('üîç School filtering debug:');
                        console.log('   this.currentSchoolId:', this.currentSchoolId);
                        console.log('   window.databaseService.currentSchool:', window.databaseService.currentSchool);
                        console.log('   Final schoolId for filtering:', schoolId);
                        console.log('   this.isAdmin:', this.isAdmin);
                        
                        if (!schoolId) {
                            throw new Error('No school context available for data filtering');
                        }
                        
                        console.log('üè´ Loading data for school ID:', schoolId);
                        quizQuery = quizQuery.eq('school_id', schoolId);
                    } else {
                        console.log('üëë Loading data for all schools (admin view)');
                    }
                    
                    // Execute the query
                    const { data: quizData, error: quizError } = await quizQuery;

                    if (quizError) {
                        console.error('‚ùå Quiz query error:', quizError);
                        throw quizError;
                    }

                    this.quizData = quizData || [];
                    console.log('üìà Loaded', this.quizData.length, 'quiz sessions');
                    
                    // Debug: Show which school IDs are in the returned data
                    if (this.quizData.length > 0) {
                        const schoolIds = [...new Set(this.quizData.map(q => q.school_id))];
                        console.log('üè´ School IDs in returned data:', schoolIds);
                        console.log('üéØ Expected school ID:', this.currentSchoolId);
                    }
                    
                    // Debug: Show sample quiz data with detailed structure
                    if (this.quizData.length > 0) {
                        console.log('üìã Sample quiz data:', this.quizData[0]);
                        console.log('üìã Quiz columns available:', Object.keys(this.quizData[0]));
                        console.log('üìã First quiz values:', {
                            student_name: this.quizData[0].student_name,
                            total_correct: this.quizData[0].total_correct,
                            total_questions: this.quizData[0].total_questions,
                            paragraph_title: this.quizData[0].paragraph_title,
                            created_at: this.quizData[0].created_at
                        });
                        
                        // Show all column names and values for debugging
                        console.log('üîç ALL COLUMNS AND VALUES:');
                        Object.keys(this.quizData[0]).forEach(key => {
                            console.log(`  ${key}: ${this.quizData[0][key]}`);
                        });
                    }
                    
                    // Try to get word statistics with detailed debugging
                    try {
                        console.log('üîç Checking word_responses table...');
                        
                        // Get word responses for the loaded quiz sessions
                        const quizSessionIds = this.quizData.map(quiz => quiz.id);
                        
                        let wordQuery = window.databaseService.supabase
                            .from('word_responses')
                            .select('*')
                            .limit(1000);
                        
                        // Filter by quiz sessions if we have any
                        if (quizSessionIds.length > 0) {
                            wordQuery = wordQuery.in('quiz_session_id', quizSessionIds);
                        }
                        
                        const { data: wordData, error: wordError } = await wordQuery;

                        console.log('üìä Word responses query result:', { wordData, wordError });
                        console.log('üìä Word data length:', wordData?.length || 0);

                        if (!wordError && wordData && wordData.length > 0) {
                            console.log('üìä Sample word response:', wordData[0]);
                            this.wordStats = this.calculateWordStats(wordData);
                            console.log('üî§ Calculated word stats:', this.wordStats);
                        } else {
                            this.wordStats = [];
                            console.log('üî§ No word data found. Error:', wordError?.message || 'No error, just no data');
                        }
                    } catch (error) {
                        this.wordStats = [];
                        console.log('üî§ Word stats error:', error.message);
                    }
                    
                    // Update the dashboard
                    this.updateStats();
                    await this.updateRecentQuizzes();
                    this.updateWordStats();
                    
                    // Show the dashboard
                    this.hideLoading();
                    this.showDashboard();
                    
                } catch (error) {
                    console.error('‚ùå Failed to load dashboard data:', error);
                    console.error('Error details:', error);
                    this.hideLoading();
                    this.showErrorMessage(`Failed to load quiz data: ${error.message}`);
                }
            }

            updateStats() {
                if (!this.quizData.length) return;

                // Calculate statistics with your actual database columns
                const totalQuizzes = this.quizData.length;
                const uniqueStudents = new Set(this.quizData.map(q => q.student_name)).size;
                
                // Calculate average score (only if we have the data)
                let avgScore = 0;
                const validQuizzes = this.quizData.filter(q => q.total_correct !== null && q.total_questions !== null && q.total_questions > 0);
                
                if (validQuizzes.length > 0) {
                    avgScore = Math.round(
                        validQuizzes.reduce((sum, q) => sum + (q.total_correct / q.total_questions * 100), 0) / validQuizzes.length
                    );
                }
                
                console.log('üìä Score calculation:', { totalQuizzes, validQuizzes: validQuizzes.length, avgScore });

                // Skip average time since total_time_seconds doesn't exist in your database
                const avgTime = 'N/A';

                // Update the display
                document.getElementById('totalQuizzes').textContent = totalQuizzes;
                document.getElementById('totalStudents').textContent = uniqueStudents;
                document.getElementById('averageScore').textContent = avgScore > 0 ? `${avgScore}%` : 'N/A';
                document.getElementById('averageTime').textContent = avgTime;
            }

            async updateRecentQuizzes() {
                const container = document.getElementById('recentQuizzes');
                
                if (!this.quizData.length) {
                    container.innerHTML = '<div class="no-data">No quiz results found yet. Students need to complete some quizzes first!</div>';
                    return;
                }

                // Create table with school column for admin users
                let html = `
                    <table class="quiz-table">
                        <thead>
                            <tr>
                                <th>üë§ Student</th>
                                <th>üìÖ Date</th>
                                <th>üéØ Score</th>
                                <th>‚ö° First Attempt</th>
                                <th>‚è±Ô∏è Time</th>
                                <th>üìñ Paragraph</th>
                                ${this.isAdmin ? '<th>üè´ School</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Show most recent 20 quizzes
                const recentQuizzes = this.quizData.slice(0, 20);
                
                // Process quizzes with async school name lookup
                for (const quiz of recentQuizzes) {
                    // Better score calculation with debugging
                    let score = 0;
                    if (quiz.total_correct !== null && quiz.total_questions !== null && quiz.total_questions > 0) {
                        score = Math.round((quiz.total_correct / quiz.total_questions) * 100);
                    }
                    
                    const scoreClass = this.getScoreClass(score);
                    const date = new Date(quiz.created_at).toLocaleDateString();
                    
                    // Get school name if admin
                    let schoolName = '';
                    if (this.isAdmin && quiz.school_id) {
                        schoolName = await this.getSchoolName(quiz.school_id);
                    }
                    
                    // Debug log for each quiz
                    console.log('Quiz data:', {
                        student: quiz.student_name,
                        correct: quiz.total_correct,
                        total: quiz.total_questions,
                        calculatedScore: score,
                        schoolId: quiz.school_id,
                        schoolName: schoolName
                    });
                    
                    html += `
                        <tr>
                            <td><strong>${quiz.student_name}</strong></td>
                            <td>${date}</td>
                            <td><span class="score ${scoreClass}">${score}%</span></td>
                            <td>${quiz.total_correct || 0}/${quiz.total_questions || 0}</td>
                            <td>N/A</td>
                            <td>${quiz.paragraph_title || 'Unknown'}</td>
                            ${this.isAdmin ? `<td>${schoolName}</td>` : ''}
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            updateWordStats() {
                const container = document.getElementById('wordStats');
                
                if (!this.wordStats.length) {
                    container.innerHTML = '<div class="no-data">No word statistics available yet.</div>';
                    return;
                }

                let html = '<div class="word-stats">';
                
                // Show the 20 most difficult words
                const difficultWords = this.wordStats.slice(0, 20);
                
                difficultWords.forEach(word => {
                    const isDifficult = word.successRate < 70;
                    
                    html += `
                        <div class="word-stat ${isDifficult ? 'difficult' : ''}">
                            <h4>${word.word}</h4>
                            <p><strong>Success Rate:</strong> ${word.successRate}%</p>
                            <p><strong>First Try:</strong> ${word.firstAttemptRate}%</p>
                            <p><strong>Attempts:</strong> ${word.totalAttempts}</p>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            calculateWordStats(wordData) {
                const wordStats = {};
                
                wordData.forEach(response => {
                    const word = response.correct_word;
                    if (!wordStats[word]) {
                        wordStats[word] = {
                            word: word,
                            totalAttempts: 0,
                            totalCorrect: 0
                        };
                    }
                    
                    wordStats[word].totalAttempts++;
                    if (response.is_correct) {
                        wordStats[word].totalCorrect++;
                    }
                });

                // Convert to array and add success rates
                const statsArray = Object.values(wordStats).map(stat => ({
                    ...stat,
                    successRate: Math.round((stat.totalCorrect / stat.totalAttempts) * 100)
                }));

                // Sort by difficulty (lowest success rate first)
                return statsArray.sort((a, b) => a.successRate - b.successRate);
            }

            getScoreClass(score) {
                if (score >= 90) return 'excellent';
                if (score >= 75) return 'good';
                if (score >= 60) return 'fair';
                return 'needs-work';
            }

            async getSchoolName(schoolId) {
                // Check if we already have this school name cached
                if (this.schoolNameCache && this.schoolNameCache[schoolId]) {
                    return this.schoolNameCache[schoolId];
                }
                
                // Initialize cache if it doesn't exist
                if (!this.schoolNameCache) {
                    this.schoolNameCache = {};
                }
                
                try {
                    // Look up the school name from the database
                    const { data: schoolData, error } = await window.databaseService.supabase
                        .from('schools')
                        .select('school_name')
                        .eq('id', schoolId)
                        .single();

                    if (error || !schoolData) {
                        console.warn('Could not find school name for ID:', schoolId);
                        // Fallback mapping for known schools
                        const fallbackMap = {
                            '1': 'Kent College',
                            '2': 'Victory Heights Primary School'
                        };
                        const fallbackName = fallbackMap[schoolId] || `School ${schoolId}`;
                        this.schoolNameCache[schoolId] = fallbackName;
                        return fallbackName;
                    }

                    // Cache and return the school name
                    this.schoolNameCache[schoolId] = schoolData.school_name;
                    return schoolData.school_name;
                    
                } catch (error) {
                    console.error('Error looking up school name:', error);
                    const fallbackName = `School ${schoolId}`;
                    this.schoolNameCache[schoolId] = fallbackName;
                    return fallbackName;
                }
            }

            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            showDashboard() {
                document.getElementById('dashboardContent').style.display = 'block';
            }

            showErrorMessage(message) {
                const container = document.getElementById('dashboardContent');
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="no-data">
                        <h3>‚ùå ${message}</h3>
                        <p>Please check your database connection and try again.</p>
                        <button class="btn" onclick="location.reload()">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        // üåç Global functions
        async function refreshData() {
            console.log('üîÑ Refreshing dashboard data...');
            const dashboard = window.teacherDashboard;
            
            if (dashboard && dashboard.isConnected) {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';
                
                await dashboard.loadDashboardData();
            } else {
                alert('‚ùå Database not connected. Please refresh the page.');
            }
        }

        async function exportData() {
            console.log('üìÅ Exporting quiz data...');
            
            if (window.databaseService && window.databaseService.isConnected) {
                try {
                    const quizData = await window.databaseService.getSchoolQuizzes(1000);
                    window.databaseService.exportQuizDataAsCSV(quizData);
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('‚ùå Failed to export data: ' + error.message);
                }
            } else {
                alert('‚ùå Database not connected. Cannot export data.');
            }
        }

        // üöÄ Initialize page when loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            checkAuthentication();
        });
    </script>
</body>
</html> 